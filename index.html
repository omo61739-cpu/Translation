<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>‡πÅ‡∏õ‡∏•+ | PDF Thai Overlay (Blocks)</title>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";</script>
<style>
:root{--bg:#0f1218;--panel:#161b23;--text:#e9edf4;--muted:#9fb0c9;--font:"Sarabun",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;--scale:1.1;--lh:1.8;--cover:.98;--mask:.85}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:var(--font)}
.top{position:sticky;top:0;z-index:10;background:#111725;border-bottom:1px solid #1e2533;padding:10px 12px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.brand{font-weight:700;background:#0d1220;border:1px solid #20283a;border-radius:10px;padding:6px 10px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn,.field,.select{background:#151c28;border:1px solid #2a3549;color:#e9edf4;padding:8px 10px;border-radius:10px}
.btn{cursor:pointer;transition:.15s}.btn:hover{transform:translateY(-1px);border-color:#3a465e}
.btn.primary{background:linear-gradient(135deg,rgba(89,157,221,.32),rgba(139,209,125,.32));border-color:#2f7d9f;box-shadow:0 6px 18px rgba(66,161,236,.22);padding:10px 18px;font-weight:700}
.hint{color:var(--muted);font-size:12px}
.wrap{display:grid;grid-template-columns:1fr 420px;gap:14px;padding:14px}
#stage{background:#0b0f16;border:1px solid #1b2333;border-radius:12px;padding:12px;display:flex;align-items:center;justify-content:center;min-height:72vh}
.page{position:relative;background:#fff;border:1px solid #e9eef7;border-radius:10px;box-shadow:0 8px 18px rgba(0,0,0,.25);overflow:hidden}
canvas{display:block}
.mask{position:absolute;inset:0;background:rgba(255,255,255,var(--mask));pointer-events:none}
.overlay{position:absolute;inset:0;pointer-events:none}
.tblock{position:absolute;left:0;top:0;width:100%;white-space:pre-wrap;word-break:break-word;font-family:var(--font);font-size:calc(14px*var(--scale));line-height:var(--lh);color:#0b0f12;background:rgba(255,255,255,var(--cover));padding:.28em .38em;border-radius:6px}
.side{background:var(--panel);border:1px solid #1f2740;border-radius:12px;padding:12px}
.card{background:#111725;border:1px solid #1e2638;border-radius:10px;padding:10px;margin:8px 0}
.block{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;border:1px solid #2a384f;border-radius:12px;padding:10px;margin-top:8px}
.block h4{margin:0;font-size:15px}
.block small{color:#9fb0c9}
.log{font-family:ui-monospace,Menlo,monospace;font-size:12px;color:#b6c3db;background:#0b0f16;border:1px dashed #2a3549;border-radius:8px;padding:8px;height:140px;overflow:auto}
.badge{padding:6px 10px;border:1px solid #2a3a53;border-radius:999px}
.ok{border-color:#3f6a44;background:rgba(139,209,125,.12)} .warn{border-color:#7a3b3b;background:rgba(255,107,107,.12)}
#flow{display:none;width:100%;max-width:900px;background:#fff;color:#111;padding:20px;border-radius:12px}
#flow p{margin:0 0 1.05em 0;font-size:calc(16px*var(--scale));line-height:var(--lh)}
#flow .cap{font-weight:700;letter-spacing:.08em;text-align:center;margin:0 0 1.3em 0}
@media(max-width:980px){.wrap{grid-template-columns:1fr}#stage{min-height:68vh}}
</style>
</head>
<body>
<div class="top">
  <div class="brand">‡πÅ‡∏õ‡∏•+ (Blocks)</div>
  <div class="row">
    <input id="fileInput" type="file" class="btn" accept="application/pdf"/>
    <input id="urlInput" class="field" placeholder="‡∏´‡∏£‡∏∑‡∏≠ /pdfs/book.pdf (‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ï‡πâ‡∏≠‡∏á CORS ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)" style="min-width:320px"/>
    <button id="openUrlBtn" class="btn">‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå PDF</button>
  </div>
  <div class="row">
    <button id="prevBtn" class="btn">‚óÄ ‡∏´‡∏ô‡πâ‡∏≤</button>
    <span class="hint">‡∏´‡∏ô‡πâ‡∏≤</span>
    <input id="gotoPage" class="field" type="number" min="1" value="1" style="width:80px"/>
    <span id="pageCountHint" class="hint">/ 0</span>
    <button id="nextBtn" class="btn">‡∏´‡∏ô‡πâ‡∏≤ ‚ñ∂</button>
  </div>
  <div class="row">
    <button id="oneClickBtn" class="btn primary">üîÅ ‡πÅ‡∏õ‡∏•‡∏î‡πà‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ</button>
    <button id="flowBtn" class="btn">‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ (Flow)</button>
  </div>
  <div class="row">
    <span class="hint">‡∏Ç‡∏ô‡∏≤‡∏î</span><input id="fontScale" class="field" type="range" min="0.9" max="1.7" step="0.02" value="1.1"/>
    <span class="hint">‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î</span><input id="lineHeight" class="field" type="range" min="1.3" max="2.4" step="0.02" value="1.8"/>
    <span class="hint">‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏ß</span><input id="pageMask" class="field" type="range" min="0" max="1" step="0.02" value="0.85"/>
  </div>
</div>

<div class="wrap">
  <div id="stage">
    <div id="pageWrap" class="page" style="display:none">
      <canvas id="pdfCanvas"></canvas>
      <div id="mask" class="mask"></div>
      <div id="overlay" class="overlay"></div>
      <div id="flow"></div>
    </div>
    <div id="emptyHint" class="hint">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ ‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå PDF</div>
  </div>

  <div class="side">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•</div>
        <div id="engineBadge" class="badge warn">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
      </div>

      <!-- BLOCK: FREE -->
      <div class="block" data-block="free">
        <div>
          <h4>‡∏ü‡∏£‡∏µ (LT ‚Üí MM)</h4>
          <small>‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥: LibreTranslate ‡∏Å‡πà‡∏≠‡∏ô ‡∏ñ‡πâ‡∏≤ 429/‡∏•‡πà‡∏° ‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô MyMemory</small>
        </div>
        <button class="btn use-block">‡πÉ‡∏ä‡πâ‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏ô‡∏µ‡πâ</button>
      </div>

      <!-- BLOCK: PRO (LLM preset) -->
      <div class="block" data-block="pro">
        <div>
          <h4>‡πÇ‡∏õ‡∏£ (LLM ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏™‡∏π‡∏á)</h4>
          <small>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏°‡∏≤‡πÉ‡∏´‡πâ: Base <code>https://api.openai.com/v1</code>, Model <code>gpt-4o-mini</code> ‚Äî ‡πÉ‡∏™‡πà API key ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</small>
        </div>
        <button class="btn use-block">‡πÉ‡∏ä‡πâ‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏ô‡∏µ‡πâ</button>
      </div>

      <!-- BLOCK: CUSTOM LLM -->
      <div class="block" data-block="custom">
        <div>
          <h4>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á (LLM ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)</h4>
          <small>‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á OpenAI-compatible/Proxy ‡πÉ‡∏î ‡πÜ</small>
        </div>
        <button class="btn use-block">‡πÉ‡∏ä‡πâ‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏ô‡∏µ‡πâ</button>
      </div>

      <div class="card" id="advanced" style="display:none">
        <div style="font-weight:700;margin-bottom:6px">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ LLM</div>
        <input id="llmBase"  class="field" placeholder="Base ‡πÄ‡∏ä‡πà‡∏ô https://api.openai.com/v1">
        <input id="llmModel" class="field" placeholder="Model ‡πÄ‡∏ä‡πà‡∏ô gpt-4o-mini / llama-3.1-70b">
        <input id="llmKey"   class="field" placeholder="LLM API key">
      </div>

      <div class="card">
        <div style="font-weight:700;margin-bottom:6px">Glossary & ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</div>
        <div class="hint">‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: <code>neuron=‡∏ô‡∏¥‡∏ß‡∏£‡∏≠‡∏ô</code> / <code>Watson=‡∏ß‡∏±‡∏ï‡∏™‡∏±‡∏ô(‡∏ú‡∏°)</code></div>
        <textarea id="glossary" class="field" style="width:100%;height:90px"></textarea>
      </div>

      <div class="log" id="log">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
      <button id="testBtn" class="btn" style="width:100%;margin-top:6px">‡∏ó‡∏î‡∏™‡∏≠‡∏ö/‡∏ï‡∏£‡∏ß‡∏à‡∏ö‡∏•‡πá‡∏≠‡∏Å</button>
    </div>

    <div class="card">
      <strong>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ</strong>
      <div id="pageText" class="log" style="height:200px"></div>
    </div>
  </div>
</div>

<script>
const $=s=>document.querySelector(s);
const log=s=>{const el=$('#log');el.textContent+='\\n'+s;el.scrollTop=el.scrollHeight;};
const setLog=s=>{$('#log').textContent=s;};
const badge=(t,ok)=>{const b=$('#engineBadge');b.textContent=t;b.className='badge '+(ok?'ok':'warn');};

let pdfDoc=null,pageNum=1;const canvas=$('#pdfCanvas'),ctx=canvas.getContext('2d'),overlay=$('#overlay'),flow=$('#flow');
const pages=new Map();
const state=JSON.parse(localStorage.getItem('blocks_state')||'{}'); // {active:'free'|'pro'|'custom', llm:{base,model,key}}
if(!state.active) state.active='free';

function save(){localStorage.setItem('blocks_state',JSON.stringify(state));}

function applyTypo(){document.documentElement.style.setProperty('--scale',$('#fontScale').value);document.documentElement.style.setProperty('--lh',$('#lineHeight').value);}
function applyMask(){document.documentElement.style.setProperty('--mask',$('#pageMask').value);}

function showAdvanced(show){$('#advanced').style.display=show?'block':'none';}
function selectBlock(b){
  state.active=b; save();
  if(b==='free'){ badge('‡∏ü‡∏£‡∏µ: LT‚ÜíMM',true); showAdvanced(false); }
  if(b==='pro'){ badge('‡πÇ‡∏õ‡∏£ (LLM)',true); showAdvanced(true); if(!state.llm){state.llm={base:'https://api.openai.com/v1',model:'gpt-4o-mini',key:''};}
                 $('#llmBase').value=state.llm.base; $('#llmModel').value=state.llm.model; $('#llmKey').value=state.llm.key||''; }
  if(b==='custom'){ badge('‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á (LLM)',true); showAdvanced(true); $('#llmBase').value=state.llm?.base||''; $('#llmModel').value=state.llm?.model||''; $('#llmKey').value=state.llm?.key||''; }
}

document.querySelectorAll('.use-block').forEach(btn=>{
  btn.addEventListener('click',e=>{
    const block=e.target.closest('.block').dataset.block;
    selectBlock(block);
  });
});

async function loadBuf(buf){setLog('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‚Ä¶');pdfDoc=await pdfjsLib.getDocument({data:buf}).promise;$('#pageCountHint').textContent='/ '+pdfDoc.numPages;$('#emptyHint').style.display='none';$('#pageWrap').style.display='block';pages.clear();await renderPage(1);}
async function loadUrl(url){setLog('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF‚Ä¶');const r=await fetch(url);if(!r.ok)throw new Error('HTTP '+r.status);await loadBuf(await r.arrayBuffer());}

async function renderPage(n){
  if(!pdfDoc) return; pageNum=Math.min(Math.max(1,n),pdfDoc.numPages); $('#gotoPage').value=pageNum;
  const page=await pdfDoc.getPage(pageNum);
  const cw=document.getElementById('stage').clientWidth-40, vp0=page.getViewport({scale:1});
  const s=Math.min(2,cw/vp0.width), vp=page.getViewport({scale:s});
  canvas.width=vp.width;canvas.height=vp.height;overlay.style.width=vp.width+'px';overlay.style.height=vp.height+'px';flow.style.width=vp.width+'px';
  await page.render({canvasContext:ctx,viewport:vp}).promise;

  let cache=pages.get(pageNum);
  if(!cache){
    const tc=await page.getTextContent({normalizeWhitespace:true,includeMarkedContent:true});
    // line -> rows -> paragraphs
    const items=tc.items.map(it=>{const m=pdfjsLib.Util.transform(vp.transform,it.transform);return {x:m[4],y:m[5],h:Math.max(8,Math.hypot(m[2],m[3])),w:it.width*vp.scale,str:(it.str||'').trim()};}).filter(i=>i.str);
    const tol=4,rows=[]; for(const it of items){let r=rows.find(rr=>Math.abs(rr.y-it.y)<=tol); if(!r){r={y:it.y,h:it.h,items:[]}; rows.push(r);} r.items.push(it); r.h=Math.max(r.h,it.h);}
    const lines=rows.map(r=>{r.items.sort((a,b)=>a.x-b.x);const t=r.items.map(i=>i.str).join(' ').replace(/\s+\n\s+/g,' ').trim();const x=Math.min(...r.items.map(i=>i.x)),mx=Math.max(...r.items.map(i=>i.x+i.w));return {text:t,x,y:r.y-r.h*0.9,w:Math.max(1,mx-x),h:r.h};});
    const gap=18,blocks=[]; let cur=null; for(const ln of lines.sort((a,b)=>a.y-b.y)){if(!cur||(ln.y-(cur.y+cur.h))>gap){cur={...ln};blocks.push(cur);}else{cur.text+=(ln.text.match(/^[‚Äî‚Äì-]/)?'':' ')+ln.text;cur.w=Math.max(cur.w,(ln.x+ln.w)-Math.min(cur.x,ln.x));cur.x=Math.min(cur.x,ln.x);cur.h=Math.max(cur.h,ln.h);}}
    cache={blocks,translatedBlocks:blocks.map(b=>b.text)}; pages.set(pageNum,cache);
  }
  paint(cache.blocks,cache.translatedBlocks); setPageText(cache.translatedBlocks.join('\\n\\n'));
}
function paint(blocks,texts){overlay.innerHTML='';for(let i=0;i<blocks.length;i++){const b=blocks[i],t=texts?.[i]??b.text;const d=document.createElement('div');d.className='tblock';d.style.left=b.x+'px';d.style.top=b.y+'px';d.style.width=b.w+'px';d.textContent=t;overlay.appendChild(d);}}
function setPageText(t){const el=$('#pageText');el.textContent=t;el.scrollTop=0;}

const thaiRatio=s=>{const th=(s.match(/[\u0E00-\u0E7F]/g)||[]).length;const letters=(s.replace(/\s/g,'').match(/[A-Za-z\u0E00-\u0E7F]/g)||[]).length;return letters?th/letters:0;};
async function trLT(text){const ep='https://libretranslate.com/translate';const r=await fetch(ep,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({q:text,source:'auto',target:'th',format:'text'})}); if(!r.ok) throw new Error('LT '+r.status); const j=await r.json(); const out=j?.translatedText||''; if(thaiRatio(out)<0.1) throw new Error('LT not-thai'); return out;}
async function trMM(text){const url='https://api.mymemory.translated.net/get?q='+encodeURIComponent(text.slice(0,900))+'&langpair=en|th';const r=await fetch(url); if(!r.ok) throw new Error('MM '+r.status); const j=await r.json(); const out=j?.responseData?.translatedText||''; if(thaiRatio(out)<0.1) throw new Error('MM not-thai'); return out;}
async function trLLM(text,ctx){const base=($('#llmBase').value||state.llm?.base||'').replace(/\/+$/,''); const key=$('#llmKey').value||state.llm?.key||''; const model=$('#llmModel').value||state.llm?.model||''; if(!base||!key||!model) throw new Error('LLM not-set'); const body={model,temperature:0.2,messages:[{role:'system',content:'‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ô‡∏±‡∏Å‡πÅ‡∏õ‡∏•‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢ ‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‚Üí‡πÑ‡∏ó‡∏¢ ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ö‡∏£‡∏¥‡∏ö‡∏ó/‡πÇ‡∏ó‡∏ô/‡∏™‡∏£‡∏£‡∏û‡∏ô‡∏≤‡∏° ‡∏´‡πâ‡∏≤‡∏°‡∏™‡∏£‡∏∏‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏±‡∏î‡∏ó‡∏≠‡∏ô'},{role:'user',content:'‡∏ö‡∏£‡∏¥‡∏ö‡∏ó:\n'+ctx.slice(-1500)+'\n\n‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°:\n'+text}]}; const r=await fetch(base+'/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},body:JSON.stringify(body)}); if(!r.ok) throw new Error('LLM '+r.status); const j=await r.json(); const out=j?.choices?.[0]?.message?.content?.trim()||''; if(thaiRatio(out)<0.3) throw new Error('LLM not-thai'); return out;}

function parseGloss(){const m=new Map();($('#glossary').value||'').split(/\n+/).map(x=>x.trim()).filter(Boolean).forEach(l=>{const[k,...R]=l.split('=');if(k&&R.length)m.set(k.trim(),R.join('=').trim());}); return m;}
function applyGloss(s,gl){let o=s;gl.forEach((v,k)=>{o=o.replace(new RegExp('(?<!\\w)'+k.replace(/[.*+?^${}()|[\\]\\\\]/g,'\\$&')+'(?!\\w)','gi'),v);});return o;}
function needsFix(s){return /[A-Za-z]{3,}/.test(s)&&thaiRatio(s)<0.6;}
function splitSentences(s){return s.replace(/\n+/g,' ').split(/(?<=[.!?])\s+/).filter(Boolean);}
async function autoFix(th,ctx){ if(!needsFix(th)) return th; const parts=splitSentences(th); for(let i=0;i<parts.length;i++){ if(needsFix(parts[i])){ try{ parts[i]=await translateByBlock(parts[i],ctx,true); }catch{} } } let out=parts.join(' '); if(!needsFix(out)) return out; const words=[...new Set(out.match(/\b[A-Za-z]{3,}\b/g)||[])].slice(0,12); for(const w of words){ try{ const tw=await translateByBlock(w,ctx,true); if(thaiRatio(tw)>0.3) out=out.replace(new RegExp('\\b'+w+'\\b','g'),tw);}catch{} } return out; }
function stylizeThai(s){const rules=[[/(‚Äú|‚Äù|")/g,'‚Äù'],[/('‚Äô|‚Äò)/g,'‚Äô'],[/‚Ä¶/g,'‚Ä¶'],[/--/g,'‚Äî'],[/ - /g,' ‚Äî '],[/\s+([.,!?;:])/g,'$1']]; let o=s; for(const[r,t] of rules) o=o.replace(r,t); return o;}
function collectCtx(n){let ctx=''; for(let i=Math.max(1,n-2); i<n; i++){ const c=pages.get(i); if(c?.translatedBlocks) ctx+=c.translatedBlocks.join('\\n')+'\\n'; } return ctx;}

async function translateByBlock(text,ctx,fixPhase=false){
  const gl=parseGloss(); text=applyGloss(text,gl);
  const mode=state.active;
  const order = (mode==='free') ? ['lt','mm','llm'] : ['llm','lt','mm'];
  for(const eng of order){
    try{
      let out = eng==='lt'? await trLT(text) : eng==='mm'? await trMM(text) : await trLLM(text,ctx);
      out = applyGloss(out,gl);
      if(!fixPhase) out = stylizeThai(out);
      return out;
    }catch(e){ log('['+eng+'] '+e.message); }
  }
  throw new Error('‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡∏ô‡∏ï‡πå‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏ô‡∏µ‡πâ');
}

async function oneClick(){
  if(!pdfDoc) return alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£');
  const cache=pages.get(pageNum); if(!cache||!cache.blocks?.length){ setLog('‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°'); return; }
  setLog(`‡πÅ‡∏õ‡∏•‡∏î‡πà‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ${pageNum} (${state.active})`);
  const ctx=collectCtx(pageNum); const out=[];
  for(let i=0;i<cache.blocks.length;i++){
    const src=cache.blocks[i].text;
    try{
      let th = await translateByBlock(src,ctx,false);
      th = await autoFix(th,ctx);
      out.push(th);
    }catch(e){ out.push(src); log(`[‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤ ${i+1}] ‡πÉ‡∏ä‡πâ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö (${e.message})`); }
    await new Promise(r=>setTimeout(r, 550));
  }
  cache.translatedBlocks=out; paint(cache.blocks,out); setPageText(out.join('\\n\\n')); setLog('‡πÄ‡∏™‡∏£‡πá‡∏à ‚úì');
}

function renderFlow(){const c=pages.get(pageNum); if(!c?.translatedBlocks?.length){ setLog('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÅ‡∏õ‡∏•‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ'); return; } const texts=c.translatedBlocks, maybe=c.blocks[0]?.text?.trim(); flow.innerHTML=''; if(maybe&&maybe.length<24&&/^[A-Z ]+$/i.test(maybe)){const cap=document.createElement('p');cap.className='cap';cap.textContent=texts[0];flow.appendChild(cap);texts.slice(1).forEach(t=>{const p=document.createElement('p');p.textContent=t;flow.appendChild(p);});} else {texts.forEach(t=>{const p=document.createElement('p');p.textContent=t;flow.appendChild(p);});}}

async function testBlock(){
  try{
    const sample='Hello';
    if(state.active==='free'){ try{await trLT(sample); badge('‡∏ü‡∏£‡∏µ: LT ‡∏û‡∏£‡πâ‡∏≠‡∏°',true);}catch{await trMM(sample); badge('‡∏ü‡∏£‡∏µ: MM ‡∏û‡∏£‡πâ‡∏≠‡∏°',true);} }
    else{ await trLLM('‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•', ''); badge('‡πÇ‡∏õ‡∏£/‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á: LLM ‡∏û‡∏£‡πâ‡∏≠‡∏°',true); }
    log('‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ú‡πà‡∏≤‡∏ô ‚úì');
  }catch(e){ badge('‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ',false); log('‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: '+e.message+' (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô LLM ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà Base/Model/Key)'); }
}

/* events */
document.addEventListener('DOMContentLoaded', ()=>{
  $('#fileInput').addEventListener('change', async e=>{const f=e.target.files?.[0]; if(!f) return; loadBuf(await f.arrayBuffer()).catch(err=>setLog('‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+err.message));});
  $('#openUrlBtn').addEventListener('click', ()=>{const u=$('#urlInput').value.trim(); if(u) loadUrl(u).catch(err=>setLog('‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏°‡∏±‡∏Å CORS): '+err.message));});
  $('#prevBtn').addEventListener('click', ()=>renderPage(pageNum-1));
  $('#nextBtn').addEventListener('click', ()=>renderPage(pageNum+1));
  $('#gotoPage').addEventListener('change', ()=>renderPage(parseInt($('#gotoPage').value||'1',10)));
  $('#fontScale').addEventListener('input', applyTypo);
  $('#lineHeight').addEventListener('input', applyTypo);
  $('#pageMask').addEventListener('input', applyMask);
  $('#oneClickBtn').addEventListener('click', oneClick);
  $('#flowBtn').addEventListener('click', ()=>{const on=flow.style.display!=='block'; if(on) renderFlow(); flow.style.display=on?'block':'none'; overlay.style.display=on?'none':'block'; canvas.style.display=on?'none':'block';});
  $('#testBtn').addEventListener('click', testBlock);
  $('#llmBase').addEventListener('input', e=>{state.llm=state.llm||{};state.llm.base=e.target.value;save();});
  $('#llmModel').addEventListener('input', e=>{state.llm=state.llm||{};state.llm.model=e.target.value;save();});
  $('#llmKey').addEventListener('input', e=>{state.llm=state.llm||{};state.llm.key=e.target.value;save();});

  applyTypo(); applyMask(); selectBlock(state.active);
});
</script>
</body>
</html>
