<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>แปล+ | PDF Thai Overlay (auto-fallback)</title>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";</script>
<style>
:root{--bg:#0f1218;--card:#161b23;--text:#e9edf4;--muted:#9fb0c9;--font:"Sarabun",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;--font-scale:1;--cover:.92}
*{box-sizing:border-box}html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:var(--font)}
.top{position:sticky;top:0;z-index:10;background:#111725;border-bottom:1px solid #1e2533;padding:10px 12px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.brand{font-weight:700;background:#0d1220;border:1px solid #20283a;border-radius:10px;padding:6px 10px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}.btn,.field,.select{background:#151c28;border:1px solid #2a3549;color:var(--text);padding:8px 10px;border-radius:10px}
.btn{cursor:pointer;transition:.15s}.btn:hover{transform:translateY(-1px);border-color:#3a465e}.btn.acc{background:linear-gradient(135deg,rgba(89,157,221,.18),rgba(139,209,125,.18));border-color:#356a7c}
.wrap{display:grid;grid-template-columns:1fr 360px;gap:14px;padding:14px}
#stage{background:#0b0f16;border:1px solid #1b2333;border-radius:12px;padding:12px;display:flex;align-items:center;justify-content:center;min-height:72vh}
.page{position:relative;background:#fff;border:1px solid #e9eef7;border-radius:10px;box-shadow:0 8px 18px rgba(0,0,0,.25);overflow:hidden}
canvas{display:block}.overlay{position:absolute;inset:0;pointer-events:none}
.tline{position:absolute;white-space:pre-wrap;line-height:1.25;transform-origin:top left;font-family:var(--font);font-size:calc(12px*var(--font-scale));color:#0a0e12;background:rgba(255,255,255,0);padding:0 .12em;border-radius:2px}
.mode-bi canvas{opacity:.6;filter:grayscale(12%) contrast(105%)}.side{background:var(--card);border:1px solid #1f2740;border-radius:12px;padding:12px}
.card{background:#111725;border:1px solid #1e2638;border-radius:10px;padding:10px;margin:8px 0}
.log{font-family:ui-monospace,Menlo,monospace;font-size:12px;color:#b6c3db;background:#0b0f16;border:1px dashed #2a3549;border-radius:8px;padding:8px;height:120px;overflow:auto}
.badge{padding:6px 10px;border:1px solid #2a3a53;border-radius:999px;color:#cfd8e6}.ok{border-color:#3f6a44;background:rgba(139,209,125,.12)}.warn{border-color:#7a3b3b;background:rgba(255,107,107,.12)}
@media(max-width:980px){.wrap{grid-template-columns:1fr}#stage{min-height:68vh}}
</style>
</head>
<body>
<div class="top">
  <div class="brand">แปล+ (PDF Thai Overlay)</div>
  <div class="row">
    <input id="fileInput" type="file" class="btn" accept="application/pdf"/>
    <input id="urlInput" class="field" placeholder="หรือ /pdfs/book.pdf (ลิงก์ต้อง CORS เดียวกัน)" style="min-width:320px"/>
    <button id="openUrlBtn" class="btn">เปิดลิงก์ PDF</button>
  </div>
  <div class="row">
    <button id="prevBtn" class="btn">◀ หน้า</button>
    <span class="field" style="padding:6px 10px;background:#101621;border-color:#223047">หน้า</span>
    <input id="gotoPage" class="field" type="number" min="1" value="1" style="width:80px"/>
    <span id="pageCountHint" class="field" style="padding:6px 10px;background:#101621;border-color:#223047">/ 0</span>
    <button id="nextBtn" class="btn">หน้า ▶</button>
  </div>
  <div class="row">
    <button id="modeOrig" class="btn">ต้นฉบับ</button>
    <button id="modeThai" class="btn">แปล</button>
    <button id="modeBi" class="btn">สองภาษา</button>
    <select id="fontSel" class="select"><option value="'Sarabun'">Sarabun (TH)</option><option value="system-ui" selected>System UI</option></select>
    <input id="fontScale" class="field" type="range" min="0.85" max="1.6" step="0.02" value="1.00"/><span class="field" style="padding:6px 10px;background:#101621;border-color:#223047">ขนาด</span>
  </div>
  <div class="row">
    <button id="translatePageBtn" class="btn acc">แปลหน้าปัจจุบัน</button>
    <button id="translateAllBtn" class="btn acc">แปลทั้งเล่ม</button>
  </div>
</div>

<div class="wrap">
  <div id="stage">
    <div id="pageWrap" class="page" style="display:none">
      <canvas id="pdfCanvas"></canvas>
      <div id="overlay" class="overlay"></div>
    </div>
    <div id="emptyHint" class="field" style="background:#101621;border-color:#223047">ยังไม่มีเอกสาร — เลือกไฟล์หรือใส่ลิงก์ PDF</div>
  </div>

  <div class="side">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">แปล/ตั้งค่า</div>
        <div id="endpointBadge" class="badge warn">ยังไม่ทดสอบ</div>
      </div>
      <div class="row" style="margin-top:8px">
        <label class="field" style="padding:6px 10px;background:#101621;border-color:#223047"><input id="useLibre" type="checkbox" checked/> ใช้ LibreTranslate</label>
        <select id="endpointPreset" class="select">
          <option value="auto" selected>Auto fallback</option>
          <option value="https://libretranslate.com/translate">libretranslate.com</option>
          <option value="https://translate.astian.org/translate">astian.org</option>
          <option value="https://libretranslate.de/translate">libretranslate.de</option>
          <option value="custom">กำหนดเอง…</option>
        </select>
        <button id="testEndpointBtn" class="btn">ทดสอบตัวแปล</button>
      </div>
      <input id="endpoint" class="field" value="https://libretranslate.com/translate" placeholder="ปลายทาง /translate (กำหนดเอง)"/>
      <input id="apiKey" class="field" placeholder="API key (ถ้าปลายทางกำหนด)" />
      <div class="field" style="padding:6px 10px;background:#101621;border-color:#223047;margin-top:6px">ปลายทางต้องลงท้ายด้วย <code>/translate</code></div>

      <div class="card" style="margin-top:10px">
        <label class="field" style="padding:6px 10px;background:#101621;border-color:#223047"><input id="coverToggle" type="checkbox" checked/> ปิดทับข้อความเดิม</label>
        <div class="row" style="margin-top:6px">
          <input id="coverAlpha" class="field" type="range" min="0" max="1" step="0.05" value="0.92"/><span class="field" style="padding:6px 10px;background:#101621;border-color:#223047">ความทึบพื้นหลังแปล</span>
        </div>
      </div>

      <div class="field" style="padding:6px 10px;background:#101621;border-color:#223047;margin-top:8px">Glossary (รูปแบบ: <code>neuron=นิวรอน</code>)</div>
      <textarea id="glossary" class="field" style="width:100%;height:70px"></textarea>

      <div class="log" id="log" style="margin-top:10px">พร้อมใช้งาน</div>
      <div class="row" style="justify-content:flex-end;margin-top:6px"><button id="clearLogBtn" class="btn">เคลียร์บันทึก</button></div>
    </div>

    <div class="card">
      <strong>ข้อความของหน้านี้</strong>
      <div id="pageText" class="log" style="height:160px"></div>
    </div>
  </div>
</div>

<script>
const $=s=>document.querySelector(s);
const log=s=>{const el=$('#log');el.textContent+='\\n'+s;el.scrollTop=el.scrollHeight;};
const setLog=s=>{$('#log').textContent=s;};
const badge=(txt,ok)=>{const b=$('#endpointBadge');b.textContent=txt;b.className='badge '+(ok?'ok':'warn');};

let pdfDoc=null,pageNum=1,pagesCache=new Map();
const canvas=$('#pdfCanvas'),ctx=canvas.getContext('2d'),overlay=$('#overlay');

function setMode(m){const st=document.getElementById('stage');st.classList.remove('mode-bi');overlay.style.display=(m==='orig')?'none':'block';if(m==='bi')st.classList.add('mode-bi');}
function applyFont(){document.documentElement.style.setProperty('--font-scale',$('#fontScale').value);overlay.querySelectorAll('.tline').forEach(d=>d.style.fontFamily=$('#fontSel').value);}
function applyCover(){const use=$('#coverToggle').checked,a=parseFloat($('#coverAlpha').value||'0');document.documentElement.style.setProperty('--cover',a);overlay.querySelectorAll('.tline').forEach(d=>d.style.background=use?'rgba(255,255,255,var(--cover))':'rgba(255,255,255,0)');}

async function loadBuf(buf){setLog('กำลังเปิดไฟล์…');pdfDoc=await pdfjsLib.getDocument({data:buf}).promise;$('#pageCountHint').textContent='/ '+pdfDoc.numPages;$('#emptyHint').style.display='none';$('#pageWrap').style.display='block';pagesCache.clear();await renderPage(1);}
async function loadUrl(url){setLog('กำลังดาวน์โหลด PDF…');const r=await fetch(url);if(!r.ok)throw new Error('HTTP '+r.status);await loadBuf(await r.arrayBuffer());}
async function renderPage(n){if(!pdfDoc)return;pageNum=Math.min(Math.max(1,n),pdfDoc.numPages);$('#gotoPage').value=pageNum;const page=await pdfDoc.getPage(pageNum);const cw=document.getElementById('stage').clientWidth-40;const vp0=page.getViewport({scale:1});const s=Math.min(2,cw/vp0.width);const vp=page.getViewport({scale:s});canvas.width=vp.width;canvas.height=vp.height;overlay.style.width=vp.width+'px';overlay.style.height=vp.height+'px';await page.render({canvasContext:ctx,viewport:vp}).promise;const cache=pagesCache.get(pageNum)||{lines:null,translated:null};if(!cache.lines){const tc=await page.getTextContent({normalizeWhitespace:true,includeMarkedContent:true});cache.lines=group(tc,vp);cache.translated=cache.lines.map(l=>l.text);pagesCache.set(pageNum,cache);}draw(cache.lines,cache.translated);setPageText((cache.translated||cache.lines).map(x=>typeof x==='string'?x:x.text).join('\\n'));}
function group(tc,vp){const items=tc.items.map(it=>{const m=pdfjsLib.Util.transform(vp.transform,it.transform);const x=m[4],y=m[5],h=Math.max(8,Math.hypot(m[2],m[3])),w=it.width*vp.scale;return {x,y,w,h,str:it.str?.trim()||''};}).filter(i=>i.str);const tol=4,rows=[];for(const it of items){let r=rows.find(rr=>Math.abs(rr.y-it.y)<=tol);if(!r){r={y:it.y,h:it.h,items:[]};rows.push(r);}r.items.push(it);r.h=Math.max(r.h,it.h);}return rows.map(r=>{r.items.sort((a,b)=>a.x-b.x);const text=r.items.map(i=>i.str).join(' ').replace(/\s+\n\s+/g,'\n').trim();const x=Math.min(...r.items.map(i=>i.x)),mx=Math.max(...r.items.map(i=>i.x+i.w));return {text,x,y:r.y,w:Math.max(1,mx-x),h:r.h};}).filter(l=>l.text.replace(/\s+/g,'').length>0);}
function draw(lines,translated){overlay.innerHTML='';const use=$('#coverToggle').checked;for(let i=0;i<lines.length;i++){const ln=lines[i],t=translated?.[i]??ln.text;const d=document.createElement('div');d.className='tline';d.style.left=ln.x+'px';d.style.top=(ln.y-ln.h*0.85)+'px';d.style.width=ln.w+'px';d.style.height=ln.h+'px';d.style.fontFamily=$('#fontSel').value;d.style.background=use?'rgba(255,255,255,var(--cover))':'rgba(255,255,255,0)';d.textContent=t;overlay.appendChild(d);}}
function parseGloss(){const m=new Map();($('#glossary').value||'').split(/\n+/).map(s=>s.trim()).filter(Boolean).forEach(l=>{const[k,...R]=l.split('=');if(k&&R.length)m.set(k.trim(),R.join('=').trim());});return m;}
function applyGloss(t,m){let o=t;m.forEach((v,k)=>{o=o.replace(new RegExp('(?<!\\w)'+k.replace(/[.*+?^${}()|[\\]\\\\]/g,'\\$&')+'(?!\\w)','gi'),v);});return o;}
const thaiRatio=s=>{const th=(s.match(/[\u0E00-\u0E7F]/g)||[]).length;const letters=(s.replace(/\s/g,'').match(/[A-Za-z\u0E00-\u0E7F]/g)||[]).length;return letters?th/letters:0;};

/* ---- translation with auto-fallback ---- */
function endpointsToTry(){
  const preset=$('#endpointPreset').value;
  const custom=$('#endpoint').value.trim();
  const arr=[
    'https://libretranslate.com/translate',
    'https://translate.astian.org/translate',
    'https://libretranslate.de/translate'
  ];
  if(preset==='auto') return arr;
  if(preset==='custom') return [custom];
  return [preset];
}
async function translateVia(ep, text, apiKey){
  const body={q:text,source:'auto',target:'th',format:'text'};
  if(apiKey) body.api_key=apiKey;
  const r=await fetch(ep,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  if(!r.ok) throw new Error('HTTP '+r.status);
  const data=await r.json();
  if(data?.error) throw new Error(data.error);
  const out=data?.translatedText??'';
  if(thaiRatio(out)<0.10) throw new Error('ไม่ใช่ข้อความไทย');
  return out;
}
async function translateOne(text){
  if(!$('#useLibre').checked) throw new Error('ปิด LibreTranslate');
  const eps=endpointsToTry();
  const apiKey=$('#apiKey').value.trim()||null;
  let lastErr=null;
  for(const ep of eps){
    if(!/\/translate(\?|$)/.test(ep)) { lastErr=new Error('ปลายทางต้องลงท้ายด้วย /translate'); continue; }
    try{ return await translateVia(ep,text,apiKey); }
    catch(e){ lastErr=e; log(`[${ep}] ${e.message}`); }
  }
  throw lastErr||new Error('ไม่มี endpoint ที่ใช้ได้');
}
async function testEndpoint(){
  try{ const out=await translateOne('Hello'); badge('พร้อมใช้งาน',true); log('ทดสอบผ่าน: '+out); }
  catch(e){ badge('ใช้ไม่ได้: '+e.message,false); log('ทดสอบล้มเหลว: '+e.message); }
}
async function translatePage(){
  if(!pdfDoc) return alert('ยังไม่มีเอกสาร');
  const cache=pagesCache.get(pageNum); if(!cache||!cache.lines?.length){ setLog('หน้านี้ไม่มีข้อความ'); return; }
  const gl=parseGloss(), src=cache.lines.map(l=>l.text), out=new Array(src.length);
  setLog(`เริ่มแปลหน้า ${pageNum} • ${src.length} บรรทัด`);
  // เริ่มที่ concurrency=2 ถ้าเจอ 429 จะชะลอเป็น 1 (โดยดูข้อความ error)
  let concurrency=2, idx=0, fail429=false;
  async function worker(){
    while(idx<src.length){
      const i=idx++, raw=src[i];
      try{ out[i]=applyGloss(await translateOne(applyGloss(raw,gl)), gl); }
      catch(e){ out[i]=raw; if(String(e.message).includes('429')) fail429=true; log(`[แถว ${i+1}] ${e.message} → ใช้ต้นฉบับ`); await new Promise(r=>setTimeout(r,400)); }
    }
  }
  await Promise.all(Array.from({length:concurrency},worker));
  if(fail429 && concurrency>1){ // ชะลอแล้วลองเติมส่วนที่ยังเป็นต้นฉบับอีกครั้งแบบคิวเดียว
    setLog('เจอ 429 → ลดความขนานเป็น 1 แล้วลองซ้ำบรรทัดที่พลาด');
    for(let i=0;i<src.length;i++){
      if(out[i]===src[i]){ try{ out[i]=applyGloss(await translateOne(applyGloss(src[i],gl)), gl); }catch{} }
    }
  }
  cache.translated=out; draw(cache.lines,out); setPageText(out.join('\\n')); setMode('thai'); applyCover(); setLog(`แปลหน้า ${pageNum} เสร็จ ✓`);
}
async function translateAll(){ if(!pdfDoc) return alert('ยังไม่มีเอกสาร'); for(let n=1;n<=pdfDoc.numPages;n++){ await renderPage(n); await translatePage(); } setLog('แปลทั้งเล่มเสร็จ ✓'); }

/* ---- events ---- */
document.addEventListener('DOMContentLoaded',()=>{
  $('#fileInput').addEventListener('change',async e=>{const f=e.target.files?.[0];if(!f)return;loadBuf(await f.arrayBuffer()).catch(err=>setLog('เปิดไฟล์ไม่สำเร็จ: '+err.message));});
  $('#openUrlBtn').addEventListener('click',()=>{const u=$('#urlInput').value.trim();if(u)loadUrl(u).catch(err=>setLog('โหลดลิงก์ไม่สำเร็จ (มัก CORS): '+err.message));});
  $('#prevBtn').addEventListener('click',()=>renderPage(pageNum-1)); $('#nextBtn').addEventListener('click',()=>renderPage(pageNum+1));
  $('#gotoPage').addEventListener('change',()=>renderPage(parseInt($('#gotoPage').value||'1',10)));
  $('#modeOrig').addEventListener('click',()=>setMode('orig')); $('#modeThai').addEventListener('click',()=>setMode('thai')); $('#modeBi').addEventListener('click',()=>setMode('bi'));
  $('#fontSel').addEventListener('change',applyFont); $('#fontScale').addEventListener('input',applyFont); $('#coverToggle').addEventListener('change',applyCover); $('#coverAlpha').addEventListener('input',applyCover);
  $('#translatePageBtn').addEventListener('click',translatePage); $('#translateAllBtn').addEventListener('click',translateAll);
  $('#clearLogBtn').addEventListener('click',()=>setLog('พร้อมใช้งาน'));
  $('#endpointPreset').addEventListener('change',e=>{const v=e.target.value; if(v!=='custom'&&v!=='auto') $('#endpoint').value=v; badge('ยังไม่ทดสอบ',false);});
  $('#testEndpointBtn').addEventListener('click',testEndpoint);
  setMode('orig'); applyFont(); applyCover();
});
function setPageText(t){const el=$('#pageText');el.textContent=t;el.scrollTop=0;}
</script>
</body>
</html>
